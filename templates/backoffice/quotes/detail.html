{% extends 'base.html' %}

{% block title %}Quote Details - Backoffice{% endblock %}

{% block sidebar_nav %}
{% include 'includes/sidebar_backoffice.html' %}
{% endblock %}

{% block page_title %}Quote Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Quote Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calculator"></i> {{ quote.quote_number }}</span>
                <span class="badge bg-{% if quote.status == 'ACCEPTED' %}success{% elif quote.status == 'SENT' %}primary{% elif quote.status == 'GENERATED' %}info{% elif quote.status == 'EXPIRED' %}secondary{% else %}danger{% endif %} fs-6">
                    {{ quote.status }}
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Customer Information</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Name</td>
                                <td class="fw-bold">{{ quote.customer.user.get_full_name|default:quote.customer.user.email }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Email</td>
                                <td>{{ quote.customer.user.email }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Phone</td>
                                <td>{{ quote.customer.phone_number|default:"-" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Insurance Details</h5>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Type</td>
                                <td class="fw-bold">{{ quote.insurance_type.type_name }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Company</td>
                                <td>
                                    {{ quote.insurance_company.company_name }}
                                    <span class="badge bg-warning text-dark ms-1">{{ quote.insurance_company.service_rating }}★</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Application #</td>
                                <td>
                                    <a href="{% url 'backoffice_application_detail' quote.application.pk %}">
                                        {{ quote.application.application_number }}
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <!-- Premium Breakdown -->
                <h5>Premium Breakdown</h5>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td>Sum Insured</td>
                                <td class="text-end fw-bold">₹{{ quote.sum_insured|floatformat:0 }}</td>
                            </tr>
                            <tr>
                                <td>Policy Tenure</td>
                                <td class="text-end">{{ quote.policy_tenure_months }} months</td>
                            </tr>
                            <tr>
                                <td>Base Premium</td>
                                <td class="text-end">₹{{ quote.base_premium|floatformat:0 }}</td>
                            </tr>
                            <tr>
                                <td>Risk Adjustment ({{ quote.risk_adjustment_percentage }}%)</td>
                                <td class="text-end">₹{{ quote.adjusted_premium|floatformat:0 }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            {% if quote.fleet_discount_amount > 0 %}
                            <tr>
                                <td>Fleet Discount ({{ quote.fleet_discount_percentage }}%)</td>
                                <td class="text-end text-success">-₹{{ quote.fleet_discount_amount|floatformat:0 }}</td>
                            </tr>
                            {% endif %}
                            {% if quote.loyalty_discount_amount > 0 %}
                            <tr>
                                <td>Loyalty Discount ({{ quote.loyalty_discount_percentage }}%)</td>
                                <td class="text-end text-success">-₹{{ quote.loyalty_discount_amount|floatformat:0 }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td>Final Premium</td>
                                <td class="text-end fw-bold">₹{{ quote.final_premium|floatformat:0 }}</td>
                            </tr>
                            <tr>
                                <td>GST ({{ quote.gst_percentage }}%)</td>
                                <td class="text-end">₹{{ quote.gst_amount|floatformat:0 }}</td>
                            </tr>
                            <tr class="table-primary">
                                <td class="fw-bold">Total Premium</td>
                                <td class="text-end fw-bold fs-5">₹{{ quote.total_premium_with_gst|floatformat:0 }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Coverages -->
        {% if coverages %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-shield-check"></i> Selected Coverages
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Coverage</th>
                            <th>Coverage Limit</th>
                            <th>Premium</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cov in coverages %}
                        <tr>
                            <td>{{ cov.coverage_type.coverage_name }}</td>
                            <td>₹{{ cov.coverage_limit|floatformat:0 }}</td>
                            <td>₹{{ cov.coverage_premium|floatformat:0 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- Addons -->
        {% if addons %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Selected Add-ons
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Add-on</th>
                            <th>Premium</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for addon in addons %}
                        <tr>
                            <td>{{ addon.addon.addon_name }}</td>
                            <td>₹{{ addon.addon_premium|floatformat:0 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <!-- All Quotes for Same Application -->
        {% if related_quotes %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Compare with Other Quotes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Premium</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rq in related_quotes %}
                            <tr class="{% if rq.id == quote.id %}table-active{% endif %}">
                                <td>
                                    {{ rq.insurance_company.company_name }}
                                    {% if rq.id == quote.id %}<span class="badge bg-secondary ms-1">Current</span>{% endif %}
                                </td>
                                <td>₹{{ rq.total_premium_with_gst|floatformat:0 }}</td>
                                <td>
                                    <span class="badge bg-{% if rq.overall_score >= 80 %}success{% elif rq.overall_score >= 60 %}warning{% else %}secondary{% endif %}">
                                        {{ rq.overall_score }}/100
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if rq.status == 'ACCEPTED' %}success{% elif rq.status == 'SENT' %}primary{% elif rq.status == 'GENERATED' %}info{% else %}secondary{% endif %}">
                                        {{ rq.status }}
                                    </span>
                                </td>
                                <td>
                                    {% if rq.id != quote.id %}
                                    <a href="{% url 'backoffice_quote_detail' rq.pk %}" class="btn btn-sm btn-outline-primary">View</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Actions -->
        {% if quote.status == 'GENERATED' %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-gear"></i> Actions
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-success" onclick="sendToCustomer()">
                        <i class="bi bi-send"></i> Send to Customer
                    </button>
                    <button class="btn btn-outline-secondary" onclick="markExpired()">
                        <i class="bi bi-x-circle"></i> Mark as Expired
                    </button>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    Sending this quote will notify the customer via email and update the status to "SENT".
                </p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">
        <!-- Score Card -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-star"></i> Quote Score
            </div>
            <div class="card-body text-center">
                <div class="display-4 fw-bold text-{% if quote.overall_score >= 80 %}success{% elif quote.overall_score >= 60 %}warning{% else %}secondary{% endif %}">
                    {{ quote.overall_score }}
                </div>
                <p class="text-muted">out of 100</p>
                
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar bg-{% if quote.overall_score >= 80 %}success{% elif quote.overall_score >= 60 %}warning{% else %}secondary{% endif %}" 
                         role="progressbar" 
                         style="width: {{ quote.overall_score }}%">
                    </div>
                </div>
                
                <p class="small text-muted mb-0">
                    Based on affordability, coverage match, and company rating
                </p>
            </div>
        </div>
        
        <!-- Timeline -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Timeline
            </div>
            <div class="card-body">
                <div class="d-flex mb-3">
                    <div class="rounded-circle bg-success text-white p-2 me-3">
                        <i class="bi bi-check"></i>
                    </div>
                    <div>
                        <strong>Generated</strong>
                        <p class="text-muted small mb-0">{{ quote.created_at|date:"M d, Y H:i" }}</p>
                        {% if quote.generated_by %}
                        <small class="text-muted">by {{ quote.generated_by.email }}</small>
                        {% endif %}
                    </div>
                </div>
                
                {% if quote.sent_at %}
                <div class="d-flex mb-3">
                    <div class="rounded-circle bg-success text-white p-2 me-3">
                        <i class="bi bi-check"></i>
                    </div>
                    <div>
                        <strong>Sent to Customer</strong>
                        <p class="text-muted small mb-0">{{ quote.sent_at|date:"M d, Y H:i" }}</p>
                        {% if quote.sent_by %}
                        <small class="text-muted">by {{ quote.sent_by.email }}</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if quote.accepted_at %}
                <div class="d-flex mb-3">
                    <div class="rounded-circle bg-success text-white p-2 me-3">
                        <i class="bi bi-check"></i>
                    </div>
                    <div>
                        <strong>Accepted</strong>
                        <p class="text-muted small mb-0">{{ quote.accepted_at|date:"M d, Y H:i" }}</p>
                    </div>
                </div>
                {% endif %}
                
                <div class="d-flex">
                    <div class="rounded-circle bg-{% if quote.is_expired %}danger{% else %}secondary{% endif %} text-white p-2 me-3">
                        <i class="bi bi-{% if quote.is_expired %}x{% else %}clock{% endif %}"></i>
                    </div>
                    <div>
                        <strong>{% if quote.is_expired %}Expired{% else %}Expires{% endif %}</strong>
                        <p class="text-muted small mb-0">{{ quote.expiry_at|date:"M d, Y" }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Info -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-building"></i> Company Info
            </div>
            <div class="card-body">
                <h6>{{ quote.insurance_company.company_name }}</h6>
                <table class="table table-sm table-borderless">
                    <tr>
                        <td class="text-muted">Rating</td>
                        <td>{{ quote.insurance_company.service_rating }}★</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Settlement Ratio</td>
                        <td>{{ quote.insurance_company.claim_settlement_ratio|floatformat:0 }}%</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <a href="{% url 'backoffice_quotes' %}" class="btn btn-outline-secondary w-100">
            <i class="bi bi-arrow-left"></i> Back to Quotes
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
           document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
}

async function sendToCustomer() {
    if (!confirm('Send this quote to the customer? They will receive an email notification.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/quotes/{{ quote.id }}/send-to-customer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'include'
        });
        
        if (response.ok) {
            alert('Quote sent to customer successfully!');
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || JSON.stringify(error)));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}

async function markExpired() {
    if (!confirm('Mark this quote as expired? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/quotes/{{ quote.id }}/', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            credentials: 'include',
            body: JSON.stringify({ status: 'EXPIRED' })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || JSON.stringify(error)));
        }
    } catch (err) {
        alert('Network error: ' + err.message);
    }
}
</script>
{% endblock %}
